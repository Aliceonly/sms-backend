# 云独立短信调度

##  1. 项目概述

###  1.1 背景介绍

本项目（云独立短信调度）的核心在于保证短信高效、准确的送达、简单易操作的对接方式。

通过对服务的解耦、通讯方式的升级来提升系统的吞吐量。

同时在多通道的加持下，通过智能动态的通道评级、选举、降级、热插拔，增强了系统的健壮性，摆脱对单一通道的依赖。

并且提供多种对接方式，满足企业内部的各种需求。



整体架构如下：

![b1cdf7ea6d9e14fd9db1770d9643455](https://gitee.com/dengdengnc/drawingbed/raw/master/img/b1cdf7ea6d9e14fd9db1770d9643455.png)

###  1.2 技术架构

####  1.2.1 系统管理服务

![ae2028cefcb17a64850460eff37d7df](https://gitee.com/dengdengnc/drawingbed/raw/master/img/ae2028cefcb17a64850460eff37d7df.png)



#### 1.2.2 短信接收服务

![f49f89ed2f38fd9e387a98c28350f2a](https://gitee.com/dengdengnc/drawingbed/raw/master/img/f49f89ed2f38fd9e387a98c28350f2a.png)



#### 1.2.3 短信发送服务

![cebaa0415b029c398c244a01a275086](https://gitee.com/dengdengnc/drawingbed/raw/master/img/cebaa0415b029c398c244a01a275086.png)



###  1.3 项目模块介绍

项目整体工程结构和模块功能如下：

```text
ydl-sms-backend			 # 短信平台父工程
	├── ydl-sms-entity		 # 短信平台实体
	├── ydl-sms-manage		 # 系统管理服务
	├── ydl-sms-api			 # 短信接收服务，应用系统调用接口、发送短信
	├── ydl-sms-server		 # 短信发送服务，调用短信通道、发送短信
	└── ydl-sms-sdk			 # 短信SDK，应用系统引入、发送短信

```



## 2. 后台管理服务：

### 2.1. 基础属性自动注入

通过自定义注解和切面，在进行数据维护时实现实体中基础属性的自动赋值

### 2.2. 通道管理

#### 2.2.2 需求分析

- 通道信息增、删、改、查（分页、详情）
- 通道排序：通过拖动对前端通道进行排序
- 关联通道与短信签名：一个通道可以有多个签名
- 关联通道与短信模板：一个通道可以有多个模板
- 通道优先级排序后通知短信发送服务，更新缓存中的通道优先级

#### 2.2.3 业务逻辑

管理端服务有一个场景使用了redis的发布订阅模式：短信通道的优先级发生变化（如人工设置）后，通过redis发布订阅模式通知短信发送服务，短信发送服务接收到消息后自动调整短信发送时使用的通道的优先级（短信发送服务缓存了短信通道的配置信息）。

短信发送服务业务逻辑说明：

1、为了保证短信发送服务的可用性，在短信发送服务启动时会自动生成当前服务实例的一个uuid作为服务标识保存到redis中，并且定期上报服务信息证明服务状态正常

2、短信发送服务启动后会定期检查redis中的服务上报信息，如果某个实例超过规定时间没有上报则认为此服务下线，就会从redis中将此服务实例信息删除

3、短信发送服务在启动时会从数据库中查询出可用通道列表并按照优先级排序，然后缓存到redis中



## 3. 消息接收服务：

### 3.1 消息存储

**功能需求：**

- 应用系统调用短信接收服务提供的接口，由短信接收服务将信息保存到消息缓冲区（Mysql、Redis）
- 调用方式：HTTP、TCP、SDK

**将消息保存到消息缓冲区的业务逻辑为：**

1、进行短信分类，分为实时发送短信和定时发送短信

2、如果是定时发送短信则将消息保存到Mysql数据库

3、如果是实时发送短信则将消息保存到Redis队列，判断短信模板类型，如果是验证码类型则将消息保存到高优先级队列，如果是其他类型则将消息保存到普通队列

4、保存短信接收日志到Mysql数据库

### 3.2 TCP接口

本项目基于Netty进行网络编程，为短信接收服务提供**TCP接口**，应用系统可以通过TCP调用此接口来和短信接收服务对接。

涉及到的Class：

- Netty服务启动类：用于启动Netty服务
- 通道初始化器：主要目的是为程序员提供一个简单的工具，用于在某个Channel注册到EventLoop后，对这个Channel执行一些初始化操作，例如可以添加用户自定义的服务端处理器
- 服务端处理器：具体执行处理逻辑，例如读取消息

### 3.3 SDK

本项目已经对短信接收服务SDK进行开发，通过SDK可以使应用系统更加方便的调用短信接收服务。

通过SDK方式调用短信接收服务，本质上还是调用的短信接收服务提供的HTTP接口（Controller），只不过是调用的过程在SDK中进行了封装，并在测试环境中上传到Nexus搭建的maven私服中，以便在应用系统中直接通过maven坐标导入SDK使用。



## 4. 短信发送服务：

该模块的作用是从消息缓冲区获取消息并和具体的短信通道对接来发送短信。

### 4.1 需求分析

- 发送短信：实时发送、定时发送
- 通道降级：通道发送失败，选择下一通道发送短信
- 通道选举：同一通道多次发送失败，降级通道
- 服务注册：有且只有一台机器执行通道选举

### 4.2 服务注册器

**实现背景：**

为了使得短信发送服务模块支持分布式集群部署，但是对于通道选举、持久化通道等操作，只能有一个服务实例执行，其他服务实例通过redis的广播机制获得通道变化。如果要实现这一功能，需要将所有短信发送服务实例注册到某个地方，当前实现是将所有服务实例注册到Redis中。并且为了能够监控每个服务实例运行状态，需要每个服务实例定时上报并且定时进行服务检查。

**业务逻辑：**

- 服务注册，项目启动时将当前服务实例id注册到redis
- 服务上报，定期报告一次，并传入当前时间戳

- 服务检查，定期检查一次服务列表，清空超过时限没有报告的服务

### 4.3 通道实例加载器

**实现背景：**

为了使得短信发送服务支持同时存在多个通道，这些通道通过后台管理系统设置的，包括通道的名称、签名、模板、连接方式等信息。当短信发送服务启动时，或者后台管理系统设置通道时，将会初始化短信通道。

**业务逻辑：**

- 查询数据库获得通道列表
- 遍历通道列表，通过反射创建每个通道的Bean对象
- 将每个通道的Bean对象保存到集合中

### 4.4 定时短信业务处理器

定时短信业务处理器具体负责定时短信的发送。

**业务逻辑：**

- 查询数据库获取本次需要发送的定时短信
- 调用短信工厂发送短信
- 更新短信发送状态为“已处理”
- 为了防止短信重复发送，需要使用分布式锁

### 4.5 短信监听器

应用系统调用短信接收服务，短信接收服务将短信消息放入消息队列，实现短信的接收和发送的解耦，这种方案可以最大化提高短信接收服务性能，不会由于外部短信通道影响应用系统的响应，从而起到削峰填谷的效果。

本系统使用Redis集群作为消息队列，在传输短信时，采用的是生产者消费者模式。

**业务逻辑：**

- 实现一个Listener监听优先短信队列，如果有消息则调用Factory发送实时短信
- 实现一个Listener监听普通短信队列，如果有消息则调用Factory发送实时短信

### 4.6 通道消息监听器

通过Redis的发布订阅模式监听频道中的消息，调用Loader初始化通道和更新通道。

**业务逻辑：**

- 通过Redis发布订阅模式监听频道中的消息
- 如果消息为通道更新，调用通道实例Loader更新通道
- 如果消息为通道初始化，调用通道实例Loader初始化通道
